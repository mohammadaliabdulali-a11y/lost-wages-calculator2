<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Lost Wages Calculator – Blaszkow Legal</title>

<!-- Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --brand:#b31b1b; --bg:#f7f7f8; --card:#ffffff; --text:#222; --muted:#666;
}
*{box-sizing:border-box}
body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:0 1rem 3rem}
.container{max-width:1100px;margin:0 auto}
header,footer{text-align:center;margin:1.5rem 0}
header img{max-height:120px}
h1{margin:.5rem 0 0} h2{margin:0 0 .75rem}
.card{background:var(--card);border-radius:12px;padding:1rem;box-shadow:0 4px 10px rgba(0,0,0,.06);margin:1rem 0}
.controls{display:flex;gap:.5rem;flex-wrap:wrap}
button{background:var(--brand);color:#fff;border:none;border-radius:8px;padding:.6rem .9rem;cursor:pointer;font-weight:600}
button.secondary{background:#0f62fe} button.ghost{background:#eee;color:#222} button.danger{background:#c43b3b}
button:disabled{opacity:.6;cursor:not-allowed}
.table-wrap{overflow:auto}
table{width:100%;border-collapse:collapse;margin-top:.5rem;table-layout:auto}
th,td{border-bottom:1px solid #eee;padding:.5rem;text-align:right;vertical-align:top}
th:first-child,td:first-child{text-align:left}
input[type="number"],input[type="text"],input[type="password"],input[type="date"],input[type="email"]{
  width:100%;padding:.6rem .7rem;border:1px solid #ddd;border-radius:8px;text-align:right;
  font-size:16px; background:#fff;
}
input.money{
  min-width:160px; /* wider boxes for amounts */
  font-variant-numeric: tabular-nums;
}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1rem}
.muted{color:var(--muted)} .row-actions{white-space:nowrap} .help{font-size:.9rem;color:#666}
.badge{display:inline-block;padding:.15rem .5rem;border-radius:999px;background:#eee;color:#333;font-size:.8rem;margin-left:.4rem}
.thumb{height:42px;width:auto;border-radius:6px;border:1px solid #ddd}
.thumb-wrap{display:flex;gap:.4rem;flex-wrap:wrap;align-items:center}
.hidden{display:none}
hr.soft{border:0;border-top:1px solid #eee;margin:1rem 0}
</style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <header>
    <img src="new%20BLEGAL%20logo.jpg" alt="Blaszkow Legal Logo"/>
    <h1>Lost Wages Calculator</h1>
    <p class="muted">⚖️ Estimate Only – Not Legal Advice</p>
    <hr/>
  </header>

  <!-- ===== AUTH ===== -->
  <section id="loginSection" class="card">
    <h2>Login</h2>
    <div class="grid">
      <div><label>Username</label><input id="loginUsername" type="text" placeholder="e.g., jsmith"/></div>
      <div><label>Password</label><input id="loginPassword" type="password" placeholder="••••••••"/></div>
    </div>
    <div class="controls" style="margin-top:.5rem">
      <button id="loginBtn">Login</button>
      <button id="showRegisterBtn" class="ghost">Create Account</button>
      <button id="showRecoverBtn" class="secondary">Recover Account</button>
    </div>
  </section>

  <section id="registerSection" class="card hidden">
    <h2>Create Account</h2>
    <div class="grid">
      <div><label>Username</label><input id="regUsername" type="text"/></div>
      <div><label>Password</label><input id="regPassword" type="password"/></div>
      <div><label>Email (for local recovery)</label><input id="regEmail" type="email"/></div>
    </div>
    <div class="controls" style="margin-top:.5rem">
      <button id="registerBtn" class="secondary">Register</button>
      <button id="backToLogin1" class="ghost">Back to Login</button>
    </div>
    <p class="help">New accounts are <b>Employees</b> by default. Master can promote/demote users.</p>
  </section>

  <section id="recoverSection" class="card hidden">
    <h2>Recover Account</h2>
    <div class="grid">
      <div><label>For username recovery, enter email</label><input id="recEmail" type="email"/></div>
      <div><label>For password reset, enter username + email</label><input id="recUsername" type="text"/></div>
    </div>
    <div class="controls" style="margin-top:.5rem">
      <button id="recoverUsernameBtn" class="ghost">Recover Username</button>
      <button id="resetPasswordBtn" class="secondary">Reset Password</button>
      <button id="backToLogin2" class="danger">Back to Login</button>
    </div>
    <p class="help">Recovery is local only (no emails sent).</p>
  </section>

  <!-- ===== DASHBOARD ===== -->
  <section id="dashboardSection" class="card hidden">
    <h2>Dashboard <span id="whoami" class="badge"></span></h2>
    <div class="controls">
      <button id="newFormBtn" class="secondary">New Lost Wages Form</button>
      <button id="logoutBtn" class="danger">Logout</button>
    </div>

    <h3 style="margin-top:1rem">Forms</h3>
    <div class="table-wrap">
      <table id="formsTable">
        <thead><tr><th>Client</th><th>Date of Loss</th><th>Report Date</th><th>Owner</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="userAdmin" class="hidden">
      <hr class="soft"/>
      <h3>User Administration (Master only)</h3>
      <div class="table-wrap">
        <table id="usersTable">
          <thead><tr><th>Username</th><th>Role</th><th>Email</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ===== FORM ===== -->
  <section id="formSection" class="card hidden">
    <h2>Lost Wages Form</h2>
    <div class="grid">
      <div><label>First Name</label><input id="clientFirstName" type="text" placeholder="First Name"/></div>
      <div><label>Last Name</label><input id="clientLastName" type="text" placeholder="Last Name"/></div>
      <div><label>Date of Loss</label><input id="clientDateLoss" type="date"/></div>
      <div><label>Report Date</label><input id="reportDate" type="text" disabled/></div>
    </div>

    <!-- Pre-Accident -->
    <section class="card">
      <h3>Pre-Accident Weekly Earnings (Baseline)</h3>
      <p class="help">Weekly Equivalent = (Trips + Tips) ÷ (Weeks + Days/7). Baseline is the average of weekly equivalents.</p>
      <div class="controls"><button id="addPreWeekBtn">+ Add Pre Week</button></div>
      <div class="table-wrap">
        <table id="preTable" aria-label="Pre-accident earnings">
          <thead>
            <tr>
              <th>Week</th><th>Start</th><th>End</th><th>Weeks</th><th>Days (0–6)</th>
              <th>Trips ($)</th><th>Tips ($)</th><th>Weekly Eq. ($)</th><th>Screenshots</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="preBody"></tbody>
        </table>
      </div>
      <p class="help">Baseline Average (Weekly): $<b id="baselineAvg">0.00</b></p>
    </section>

    <!-- Post-Accident -->
    <section class="card">
      <h3>Post-Accident / Returned Work</h3>
      <p class="help">Lost Wages = Baseline × (Weeks + Days/7) − Actual (min 0). Attach week-specific screenshots.</p>
      <div class="controls"><button id="addPostWeekBtn">+ Add Post Week</button></div>
      <div class="table-wrap">
        <table id="postTable" aria-label="Post-accident earnings">
          <thead>
            <tr>
              <th>Week</th><th>Start</th><th>End</th><th>Weeks</th><th>Days (0–6)</th>
              <th>Actual ($)</th><th>Lost ($)</th><th>Screenshots</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="postBody"></tbody>
        </table>
      </div>
      <p class="help">Total Lost Wages: $<b id="totalLost">0.00</b></p>
    </section>

    <div class="controls">
      <button id="saveFormBtn" class="ghost">Save Form</button>
      <button id="exportPdfBtn" class="secondary">Download PDF Report</button>
      <button id="backBtn" class="danger">Back to Dashboard</button>
    </div>
    <p class="help">All data is stored locally in your browser using <code>localStorage</code>.</p>
  </section>

  <footer><hr/><p>Blaszkow Legal, PLLC</p></footer>
</div>

<script>
/* =========== Utils & Storage =========== */
const $ = (s,root=document)=>root.querySelector(s);
const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));
const num = v => { const n=parseFloat(v); return isFinite(n)? n:0; };
const fmt = n => (isFinite(n)? Number(n):0).toFixed(2);
const todayStr = () => new Date().toLocaleDateString();

const USERS_KEY='lwUsers', FORMS_KEY='lwForms';

let users = JSON.parse(localStorage.getItem(USERS_KEY)||'[]');
if(users.length===0){
  users=[{username:'admin',password:'admin',role:'master',email:''}];
  localStorage.setItem(USERS_KEY,JSON.stringify(users));
}
let currentUser=null, currentFormId=null;

/* =========== Sections =========== */
const loginSection = $('#loginSection');
const registerSection = $('#registerSection');
const recoverSection = $('#recoverSection');
const dashboardSection = $('#dashboardSection');
const formSection = $('#formSection');
function show(sec){[loginSection,registerSection,recoverSection,dashboardSection,formSection].forEach(x=>x.classList.add('hidden')); sec.classList.remove('hidden');}
show(loginSection);

/* =========== Auth =========== */
$('#loginBtn').addEventListener('click', ()=>{
  const u=$('#loginUsername').value.trim(), p=$('#loginPassword').value;
  const user=users.find(x=>x.username===u && x.password===p);
  if(!user){ alert('Invalid credentials'); return; }
  currentUser=user;
  $('#whoami').textContent=`${user.username} (${user.role})`;
  loadFormsTable(); loadUsersTable();
  $('#userAdmin').classList.toggle('hidden', currentUser.role!=='master');
  show(dashboardSection);
});
$('#logoutBtn').addEventListener('click', ()=>{ currentUser=null; show(loginSection); });
$('#showRegisterBtn').addEventListener('click', ()=> show(registerSection));
$('#backToLogin1').addEventListener('click', ()=> show(loginSection));
$('#registerBtn').addEventListener('click', ()=>{
  const username=$('#regUsername').value.trim(), password=$('#regPassword').value, email=$('#regEmail').value.trim();
  if(!username||!password){ alert('Username & password required'); return; }
  if(users.some(u=>u.username===username)){ alert('Username exists'); return; }
  users.push({username,password,email,role:'employee'});
  localStorage.setItem(USERS_KEY,JSON.stringify(users));
  alert('Account created. Login now.'); show(loginSection);
});
$('#showRecoverBtn').addEventListener('click', ()=> show(recoverSection));
$('#backToLogin2').addEventListener('click', ()=> show(loginSection));
$('#recoverUsernameBtn').addEventListener('click', ()=>{
  const email=$('#recEmail').value.trim();
  if(!email){ alert('Enter email'); return; }
  const names=users.filter(u=>(u.email||'').toLowerCase()===email.toLowerCase()).map(u=>u.username);
  if(names.length===0) alert('No usernames found for that email'); else alert('Username(s): '+names.join(', '));
});
$('#resetPasswordBtn').addEventListener('click', ()=>{
  const email=$('#recEmail').value.trim(), uname=$('#recUsername').value.trim();
  const u=users.find(x=>x.username===uname && (x.email||'').toLowerCase()===email.toLowerCase());
  if(!u){ alert('No match for username+email'); return; }
  const np=prompt('Enter new password:'); if(!np) return;
  u.password=np; localStorage.setItem(USERS_KEY,JSON.stringify(users)); alert('Password reset.');
});

/* =========== Dashboard / Users =========== */
function getForms(){return JSON.parse(localStorage.getItem(FORMS_KEY)||'[]');}
function setForms(arr){localStorage.setItem(FORMS_KEY,JSON.stringify(arr));}

const formsTbody=$('#formsTable tbody');
function loadFormsTable(){
  const forms=getForms(); formsTbody.innerHTML='';
  forms.forEach((f,i)=>{
    if(currentUser.role==='employee' && f.owner!==currentUser.username) return;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${(f.clientFirstName||'')+' '+(f.clientLastName||'')}</td>
      <td>${f.dateOfLoss||''}</td><td>${f.reportDate||''}</td><td>${f.owner}</td>
      <td class="row-actions">
        <button class="ghost editForm" data-id="${i}">Edit</button>
        <button class="danger delForm" data-id="${i}">Delete</button>
      </td>`;
    formsTbody.appendChild(tr);
  });
}
const usersTbody=$('#usersTable tbody');
function loadUsersTable(){
  usersTbody.innerHTML='';
  users.forEach((u,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${u.username}${u.username==='admin'?' <span class="badge">master</span>':''}</td>
      <td>${u.role}</td><td>${u.email||''}</td>
      <td class="row-actions">
        <button class="ghost resetPw" data-idx="${i}">Reset PW</button>
        <button class="ghost roleToggle" data-idx="${i}">Promote/Demote</button>
        <button class="danger delUser" data-idx="${i}">Delete</button>
      </td>`;
    usersTbody.appendChild(tr);
  });
}
$('#usersTable').addEventListener('click', e=>{
  const i=e.target.dataset.idx; if(i===undefined) return; const u=users[i];
  if(e.target.classList.contains('resetPw')){
    const np=prompt(`New password for ${u.username}:`); if(np){u.password=np;localStorage.setItem(USERS_KEY,JSON.stringify(users));}
  }
  if(e.target.classList.contains('roleToggle')){
    if(u.username==='admin'){ alert('Master cannot be changed'); return; }
    u.role = (u.role==='employee'?'admin':'employee');
    localStorage.setItem(USERS_KEY,JSON.stringify(users)); loadUsersTable();
  }
  if(e.target.classList.contains('delUser')){
    if(u.username==='admin'){ alert('Cannot delete master'); return; }
    if(confirm(`Delete user ${u.username}?`)){ users.splice(i,1); localStorage.setItem(USERS_KEY,JSON.stringify(users)); loadUsersTable(); }
  }
});

/* New form / Back */
$('#newFormBtn').addEventListener('click', ()=>{ currentFormId=null; clearForm(); $('#reportDate').value=todayStr(); show(formSection); });
$('#backBtn').addEventListener('click', ()=>{ show(dashboardSection); loadFormsTable(); });

/* =========== Form: Pre/Post Rows =========== */
const preBody=$('#preBody'), baselineAvgEl=$('#baselineAvg');
const postBody=$('#postBody'), totalLostEl=$('#totalLost');

function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

function renderThumbs(tr, sel){
  const wrap=tr.querySelector(sel); wrap.innerHTML='';
  (tr._images||[]).forEach((dataUrl,idx)=>{
    const img=document.createElement('img'); img.src=dataUrl; img.className='thumb';
    const del=document.createElement('button'); del.className='ghost'; del.textContent='✕';
    del.style.padding='.1rem .4rem'; del.style.borderRadius='6px';
    del.addEventListener('click', ()=>{ tr._images.splice(idx,1); renderThumbs(tr,sel); });
    const holder=document.createElement('div'); holder.style.display='flex'; holder.style.alignItems='center'; holder.style.gap='.25rem';
    holder.appendChild(img); holder.appendChild(del); wrap.appendChild(holder);
  });
}

/* ---- Pre rows ---- */
function addPreRow(data={}){
  const idx=preBody.children.length+1;
  const tr=document.createElement('tr'); tr._images=data.images?[...data.images]:[];
  tr.innerHTML=`
    <td>Week ${idx}</td>
    <td><input type="date" class="preStart" value="${data.start??''}"/></td>
    <td><input type="date" class="preEnd"   value="${data.end  ??''}"/></td>
    <td><input type="number" class="preWeeks" min="0" step="1" value="${data.weeks ?? 1}"/></td>
    <td><input type="number" class="preDays"  min="0" max="6" step="1" value="${data.days  ?? 0}"/></td>
    <td><input type="number" class="preTrips money" step="0.01" value="${data.trips??''}"/></td>
    <td><input type="number" class="preTips  money" step="0.01" value="${data.tips ??''}"/></td>
    <td>$<span class="preEq">0.00</span></td>
    <td>
      <div class="thumb-wrap"></div>
      <input type="file" class="preFiles" accept="image/png, image/jpeg" multiple/>
    </td>
    <td class="row-actions"><button class="danger rmPre">🗑</button></td>`;
  preBody.appendChild(tr);

  tr.querySelectorAll('.preWeeks,.preDays,.preTrips,.preTips').forEach(inp=>inp.addEventListener('input', recalcPre));
  tr.querySelector('.rmPre').addEventListener('click', ()=>{ tr.remove(); [...preBody.children].forEach((r,i)=>r.children[0].textContent='Week '+(i+1)); recalcPre(); });
  tr.querySelector('.preFiles').addEventListener('change', async (e)=>{
    const files=Array.from(e.target.files||[]);
    for(const f of files){ if(!/^image\/(png|jpeg)$/.test(f.type)) continue; tr._images.push(await fileToDataURL(f)); }
    e.target.value=''; renderThumbs(tr,'.thumb-wrap');
  });
  renderThumbs(tr,'.thumb-wrap');
  recalcPre();
}
$('#addPreWeekBtn').addEventListener('click', ()=> addPreRow());

function recalcPre(){
  let weeklyEquivs=[];
  $$('#preBody tr').forEach(tr=>{
    const weeks=Math.max(0,parseInt(tr.querySelector('.preWeeks').value||'1',10));
    let days=Math.max(0,parseInt(tr.querySelector('.preDays').value||'0',10)); if(days>6) days=6;
    const factor=weeks+(days/7);
    const trips=num(tr.querySelector('.preTrips').value);
    const tips=num(tr.querySelector('.preTips').value);
    const total=trips+tips;
    const eq=factor>0? total/factor : 0;
    tr.querySelector('.preEq').textContent = fmt(eq);
    if(total!==0) weeklyEquivs.push(eq);
  });
  const baseline=weeklyEquivs.length? weeklyEquivs.reduce((a,b)=>a+b,0)/weeklyEquivs.length : 0;
  baselineAvgEl.textContent = fmt(baseline);
  recalcPost();
}

/* ---- Post rows ---- */
function addPostRow(data={}){
  const idx=postBody.children.length+1;
  const tr=document.createElement('tr'); tr._images=data.images?[...data.images]:[];
  tr.innerHTML=`
    <td>Week ${idx}</td>
    <td><input type="date" class="postStart" value="${data.start??''}"/></td>
    <td><input type="date" class="postEnd"   value="${data.end  ??''}"/></td>
    <td><input type="number" class="postWeeks" min="0" step="1" value="${data.weeks ?? 1}"/></td>
    <td><input type="number" class="postDays"  min="0" max="6" step="1" value="${data.days  ?? 0}"/></td>
    <td><input type="number" class="postActual money" step="0.01" value="${data.actual??''}"/></td>
    <td>$<span class="postLost">0.00</span></td>
    <td>
      <div class="thumb-wrap"></div>
      <input type="file" class="postFiles" accept="image/png, image/jpeg" multiple/>
    </td>
    <td class="row-actions"><button class="danger rmPost">🗑</button></td>`;
  postBody.appendChild(tr);

  tr.querySelectorAll('.postWeeks,.postDays,.postActual').forEach(inp=>inp.addEventListener('input', recalcPost));
  tr.querySelector('.rmPost').addEventListener('click', ()=>{ tr.remove(); [...postBody.children].forEach((r,i)=>r.children[0].textContent='Week '+(i+1)); recalcPost(); });

  tr.querySelector('.postFiles').addEventListener('change', async (e)=>{
    const files=Array.from(e.target.files||[]);
    for(const f of files){ if(!/^image\/(png|jpeg)$/.test(f.type)) continue; tr._images.push(await fileToDataURL(f)); }
    e.target.value=''; renderThumbs(tr,'.thumb-wrap');
  });

  renderThumbs(tr,'.thumb-wrap');
  recalcPost();
}
$('#addPostWeekBtn').addEventListener('click', ()=> addPostRow());

function recalcPost(){
  const baseline=num($('#baselineAvg').textContent);
  let total=0;
  $$('#postBody tr').forEach(tr=>{
    const weeks=Math.max(0,parseInt(tr.querySelector('.postWeeks').value||'1',10));
    let days=Math.max(0,parseInt(tr.querySelector('.postDays').value||'0',10)); if(days>6) days=6;
    const factor=weeks+(days/7);
    const actual=num(tr.querySelector('.postActual').value);
    let lost = baseline*factor - actual; if(lost<0) lost=0;
    tr.querySelector('.postLost').textContent = fmt(lost);
    total += lost;
  });
  $('#totalLost').textContent = fmt(total);
}

/* =========== Save/Load Form =========== */
$('#saveFormBtn').addEventListener('click', ()=>{ saveCurrentForm(); alert('Form saved'); });

function getForms(){return JSON.parse(localStorage.getItem('lwForms')||'[]');}
function setForms(arr){localStorage.setItem('lwForms',JSON.stringify(arr));}

function collectForm(){
  const preWeeks = $$('#preBody tr').map(tr=>({
    start: tr.querySelector('.preStart').value || '',
    end:   tr.querySelector('.preEnd').value   || '',
    weeks: parseInt(tr.querySelector('.preWeeks').value||'1',10),
    days:  parseInt(tr.querySelector('.preDays').value ||'0',10),
    trips: tr.querySelector('.preTrips').value || '',
    tips:  tr.querySelector('.preTips').value  || '',
    eq:    tr.querySelector('.preEq').textContent || '0.00',
    images: tr._images || []
  }));
  const postWeeks = $$('#postBody tr').map(tr=>({
    start: tr.querySelector('.postStart').value || '',
    end:   tr.querySelector('.postEnd').value   || '',
    weeks: parseInt(tr.querySelector('.postWeeks').value||'1',10),
    days:  parseInt(tr.querySelector('.postDays').value ||'0',10),
    actual: tr.querySelector('.postActual').value || '',
    lost:   tr.querySelector('.postLost').textContent || '0.00',
    images: tr._images || []
  }));
  return {
    owner: currentUser?.username || 'unknown',
    clientFirstName: $('#clientFirstName').value,
    clientLastName:  $('#clientLastName').value,
    dateOfLoss:      $('#clientDateLoss').value,
    reportDate:      $('#reportDate').value || todayStr(),
    preWeeks, postWeeks
  };
}
function saveCurrentForm(){
  const forms=getForms(); const payload=collectForm();
  if(currentFormId!=null) forms[currentFormId]=payload; else { forms.push(payload); currentFormId=forms.length-1; }
  setForms(forms);
}
function loadForm(idx){
  const f=getForms()[idx]; if(!f) return;
  currentFormId=idx;
  $('#clientFirstName').value=f.clientFirstName||'';
  $('#clientLastName').value =f.clientLastName ||'';
  $('#clientDateLoss').value =f.dateOfLoss     ||'';
  $('#reportDate').value     =f.reportDate     ||todayStr();

  preBody.innerHTML=''; (f.preWeeks||[]).forEach(w=> addPreRow(w));
  if(preBody.children.length===0) for(let i=0;i<6;i++) addPreRow();
  recalcPre();

  postBody.innerHTML=''; (f.postWeeks||[]).forEach(w=> addPostRow(w));
  if(postBody.children.length===0) addPostRow();
  recalcPost();

  show(formSection);
}

/* Dashboard events */
$('#formsTable').addEventListener('click', (e)=>{
  if(e.target.classList.contains('editForm')){
    const id=parseInt(e.target.dataset.id,10), f=getForms()[id];
    if(!f) return;
    if(currentUser.role==='employee' && f.owner!==currentUser.username){ alert('No access'); return; }
    loadForm(id);
  }
  if(e.target.classList.contains('delForm')){
    const id=parseInt(e.target.dataset.id,10); const forms=getForms(); const f=forms[id]; if(!f) return;
    if(currentUser.role==='employee' && f.owner!==currentUser.username){ alert('No access'); return; }
    if(confirm('Delete this form?')){ forms.splice(id,1); setForms(forms); loadFormsTable(); }
  }
});

/* =========== New Form / Clear =========== */
function clearForm(){
  $('#clientFirstName').value=''; $('#clientLastName').value=''; $('#clientDateLoss').value='';
  $('#reportDate').value=todayStr();
  preBody.innerHTML=''; postBody.innerHTML='';
  for(let i=0;i<6;i++) addPreRow();
  addPostRow();
  recalcPre(); recalcPost();
}

/* =========== Export PDF (one statement per page + summary) =========== */
$('#exportPdfBtn').addEventListener('click', async ()=>{
  saveCurrentForm();
  const form=getForms()[currentFormId];
  const { jsPDF } = window.jspdf;

  // Page measurements for US Letter in points
  const pageW = 612, pageH = 792, margin = 40;
  const contentW = pageW - margin*2;

  const doc = new jsPDF({ unit:'pt', format:'letter' });

  // Helper: load image
  const loadImage = (src)=>new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=rej; img.src=src; });

  // Header template (logo + header text)
  async function pageHeader(title, sub){
    let y = margin;
    // Logo (optional)
    try{
      const img = await loadImage('new%20BLEGAL%20logo.jpg');
      const logoW = 150;
      const ratio = logoW / img.width;
      const logoH = img.height * ratio;
      doc.addImage(img,'JPEG',margin,y,logoW,logoH);
      y += logoH + 10;
    }catch(e){
      // no logo available
      y += 10;
    }
    doc.setFontSize(16);
    doc.text(title, margin, y); y += 18;
    doc.setFontSize(11);
    (sub||[]).forEach(line => { 
      const wrapped = doc.splitTextToSize(line, contentW);
      doc.text(wrapped, margin, y);
      y += 14 * wrapped.length;
    });
    y += 6;
    return y;
  }

  // Compute baseline from weekly equivalents
  function computeBaseline(preWeeks){
    const eqs=(preWeeks||[]).map(w=>{
      const weeks=parseInt(w.weeks||1,10)||0;
      const days =parseInt(w.days ||0,10)||0;
      const factor=weeks+(days/7);
      const total=num(w.trips)+num(w.tips);
      return (total!==0 && factor>0) ? (total/factor) : null;
    }).filter(v=>v!==null);
    if(eqs.length===0) return 0;
    return eqs.reduce((a,b)=>a+b,0)/eqs.length;
  }
  const baseline = computeBaseline(form.preWeeks||[]);

  // PRE PAGES (one per statement)
  for(let i=0;i<(form.preWeeks||[]).length;i++){
    if(i>0) doc.addPage();
    const w=form.preWeeks[i];
    let y = await pageHeader('Pre-Accident Statement', [
      `Client: ${form.clientFirstName||''} ${form.clientLastName||''}`,
      `Statement: ${w.start||'—'} to ${w.end||'—'}`
    ]);

    // Details block
    const weeks = parseInt(w.weeks||1,10)||0;
    const days  = parseInt(w.days ||0,10)||0;
    const factor= weeks + (days/7);
    const trips = num(w.trips), tips = num(w.tips);
    const eq    = factor>0 ? (trips+tips)/factor : 0;

    doc.setFontSize(12);
    const detailLines = [
      `Weeks: ${weeks}    Days: ${days}    Factor: ${factor.toFixed(2)}`,
      `Trips: $${fmt(trips)}    Tips: $${fmt(tips)}    Weekly Equivalent: $${fmt(eq)}`
    ];
    detailLines.forEach(line=>{
      const wrapped=doc.splitTextToSize(line, contentW);
      doc.text(wrapped, margin, y); y+=16*wrapped.length;
    });

    // Images (each scaled to content width)
    for(const dataUrl of (w.images||[])){
      try{
        const img = await loadImage(dataUrl);
        const maxW = contentW;
        const ratio = maxW / img.width;
        const wpt = maxW, hpt = img.height * ratio;
        if(y + hpt > pageH - margin){ doc.addPage(); y = await pageHeader('Pre-Accident Statement', [
          `Client: ${form.clientFirstName||''} ${form.clientLastName||''}`,
          `Statement: ${w.start||'—'} to ${w.end||'—'}`
        ]); }
        doc.addImage(img, 'JPEG', margin, y, wpt, hpt);
        y += hpt + 10;
      }catch(e){}
    }
  }

  // POST PAGES (one per statement)
  let totalLost = 0;
  for(let i=0;i<(form.postWeeks||[]).length;i++){
    doc.addPage();
    const w=form.postWeeks[i];
    let y = await pageHeader('Post-Accident Statement', [
      `Client: ${form.clientFirstName||''} ${form.clientLastName||''}`,
      `Statement: ${w.start||'—'} to ${w.end||'—'}`
    ]);

    const weeks = parseInt(w.weeks||1,10)||0;
    const days  = parseInt(w.days ||0,10)||0;
    const factor= weeks + (days/7);
    const actual= num(w.actual);
    let lost = baseline*factor - actual; if(lost<0) lost=0;
    totalLost += lost;

    doc.setFontSize(12);
    const detailLines = [
      `Baseline: $${fmt(baseline)}    Weeks: ${weeks}    Days: ${days}    Factor: ${factor.toFixed(2)}`,
      `Actual: $${fmt(actual)}    Lost Wages: $${fmt(lost)}`
    ];
    detailLines.forEach(line=>{
      const wrapped=doc.splitTextToSize(line, contentW);
      doc.text(wrapped, margin, y); y+=16*wrapped.length;
    });

    for(const dataUrl of (w.images||[])){
      try{
        const img = await loadImage(dataUrl);
        const maxW = contentW;
        const ratio = maxW / img.width;
        const wpt = maxW, hpt = img.height * ratio;
        if(y + hpt > pageH - margin){ doc.addPage(); y = await pageHeader('Post-Accident Statement', [
          `Client: ${form.clientFirstName||''} ${form.clientLastName||''}`,
          `Statement: ${w.start||'—'} to ${w.end||'—'}`
        ]); }
        doc.addImage(img, 'JPEG', margin, y, wpt, hpt);
        y += hpt + 10;
      }catch(e){}
    }
  }

  // SUMMARY PAGE
  doc.addPage();
  let y = await (async()=>await pageHeader('Summary', [
    `Client: ${form.clientFirstName||''} ${form.clientLastName||''}`,
    `Date of Loss: ${form.dateOfLoss||''}`,
    `Report Date: ${form.reportDate||todayStr()}`
  ]))();

  const preCount  = (form.preWeeks||[]).filter(w=> num(w.trips)||num(w.tips)).length;
  const postCount = (form.postWeeks||[]).length;
  const preTotal  = (form.preWeeks||[]).reduce((s,w)=> s + num(w.trips)+num(w.tips), 0);
  const postActualTotal = (form.postWeeks||[]).reduce((s,w)=> s + num(w.actual), 0);

  const summaryLines = [
    `Pre-Accident Statements Count: ${preCount}`,
    `Post-Accident Statements Count: ${postCount}`,
    `Baseline Weekly Average: $${fmt(baseline)}`,
    `Total Pre-Accident Gross (Trips + Tips): $${fmt(preTotal)}`,
    `Total Actual (Post-Accident): $${fmt(postActualTotal)}`,
    `Total Lost Wages: $${fmt(totalLost)}`
  ];
  doc.setFontSize(12);
  summaryLines.forEach(line=>{
    const wrapped=doc.splitTextToSize(line, contentW);
    doc.text(wrapped, margin, y); y+=16*wrapped.length;
  });

  const fname=(form.clientFirstName||'Client')+'_'+(form.clientLastName||'');
  doc.save(`${fname}_LostWages.pdf`);
});

/* ======================== Wire-ups ======================== */
$('#addPreWeekBtn').addEventListener('click', ()=> addPreRow());
$('#addPostWeekBtn').addEventListener('click', ()=> addPostRow());
$('#saveFormBtn').addEventListener('click', saveCurrentForm);
$('#newFormBtn').addEventListener('click', ()=>{ currentFormId=null; clearForm(); $('#reportDate').value=todayStr(); show(formSection); });

/* Initial view */
function clearForm(){
  $('#clientFirstName').value=''; $('#clientLastName').value=''; $('#clientDateLoss').value='';
  $('#reportDate').value=todayStr();
  preBody.innerHTML=''; postBody.innerHTML='';
  for(let i=0;i<6;i++) addPreRow();
  addPostRow();
  recalcPre(); recalcPost();
}
</script>
</body>
</html>
